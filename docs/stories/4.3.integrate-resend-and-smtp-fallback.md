---
title: "Story 4.3: integrate-resend-and-smtp-fallback"
status: Draft
owner: scrum-master
---

# Story 4.3 â€” Integrate Resend; document envs and fallback SMTP

## Status
Approved

## Story
**As a** developer,
**I want** to integrate Resend for email delivery with an SMTP fallback and documented env vars,
**so that** leads are delivered reliably with a vendor-agnostic escape hatch.

## Acceptance Criteria
1. Resend path succeeds with DKIM/SPF configured; SMTP fallback available. [Source: architecture/03-backend-and-integrations.md#3.2]
2. Env vars documented and stored via Vercel Encrypted Env Vars (Preview/Prod). [Source: architecture/04-infrastructure-and-deployment-topology.md#4.7]
3. Server Action reads secrets server-side only; no secrets in client bundles. [Source: architecture/03-backend-and-integrations.md#3.4]

## Tasks / Subtasks
- [ ] In `app/actions/submitLead.ts`, integrate Resend SDK using `RESEND_API_KEY`
- [ ] Send email to `SALES_EMAIL`; keep template minimal (inline HTML/text)
- [ ] Provide SMTP fallback via Nodemailer with `SMTP_*` env vars
- [ ] Document required envs in `ENV.md` with Preview/Prod separation
- [ ] Verify friendly error on send failure; return `{ ok: false, message }`

## Dev Notes

### Email Delivery & Domain Auth
- Provider: Resend with DKIM/SPF; fallback SMTP. [Source: architecture/03-backend-and-integrations.md#3.2]

### Env Vars
- `RESEND_API_KEY`, `SALES_EMAIL`, `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS`. [Source: architecture/03-backend-and-integrations.md#3.2; architecture/04-infrastructure-and-deployment-topology.md#4.7]

## Testing
- Integration test: simulate success/failure paths; ensure fallback works.
- Manual: verify email receipt in preview with masked content; ensure no secrets leak.

## Change Log
| Date       | Version | Description                                   | Author |
|------------|---------|-----------------------------------------------|--------|
| 2025-08-08 | 0.1     | Draft for Resend + SMTP fallback integration  | SM     |

## Dev Agent Record
To be filled by the development agent during implementation.


