---
title: "Story 4.2: implement-submitlead-server-action"
status: Draft
owner: scrum-master
---

# Story 4.2 — Implement `submitLead` Server Action with validation + honeypot + rate limit

## Status
Approved
In Review

## Story

**As a** developer,
**I want** a Server Action `submitLead` that validates inputs, protects against spam, and returns a friendly result,
**so that** the form can be safely submitted without exposing secrets to the client.

## Acceptance Criteria

1. Server Action validates fields with Zod; soft-warns on free-mail but allows submit. [Source: architecture/03-backend-and-integrations.md#3.1]
2. Honeypot field and simple per-IP/session rate limit are enforced. [Source: architecture/03-backend-and-integrations.md#3.1, #3.3]
3. p50 < 800ms end-to-end measured in dev; failures return friendly error message. [Source: architecture/03-backend-and-integrations.md#3.9]
4. No secrets in client bundles; only server reads env vars. [Source: architecture/03-backend-and-integrations.md#3.4]

## Tasks / Subtasks

- [x] Create `app/actions/submitLead.ts` with `'use server'`
- [x] Define Zod schema: name, email, company, whatsapp, optional hidden `website` honeypot (max 0)
- [x] Parse `FormData` → validation; return `{ ok: boolean, message?: string }`
- [x] Add simple in-memory rate limit (stub for KV upgrade) and timing guard (>800ms bot timing)
- [x] Add structured error handling; log error class + elapsed ms (server logs)
- [x] Provide TODO for email send (wired in 4.3)

## Dev Notes

### Server Action Design

- Minimal server surface with Zod validation and spam controls. [Source: architecture/03-backend-and-integrations.md#3.1, #3.3]

### Secrets & Config

- Env variables are server-only; no leakage to client bundles. [Source: architecture/03-backend-and-integrations.md#3.4]

## Testing

- Unit: schema validates/invalidates inputs; honeypot rejected; free-mail soft-warn path allowed.
- Integration: simulate rapid repeats to verify rate limit path.

## Dev Agent Record
- Added `lib/actions/submitLeadCore.ts` for schema, parsing, free-mail detection, timing, and a simple in-memory rate limiter (with tests).
- Implemented `app/actions/submitLead.ts` server action with structured logging and success path stub (email in 4.3).
- Wired `SlideOverForm` to call server action; added honeypot `website` and hidden `t0` timing guard field; emits `form_submit_success`/`form_submit_error`.

## Change Log

| Date       | Version | Description                                  | Author |
| ---------- | ------- | -------------------------------------------- | ------ |
| 2025-08-08 | 0.1     | Draft for `submitLead` Server Action created | SM     |

## Dev Agent Record

To be filled by the development agent during implementation.
