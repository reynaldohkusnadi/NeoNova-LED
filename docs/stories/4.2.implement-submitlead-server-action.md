---
title: "Story 4.2: implement-submitlead-server-action"
status: Draft
owner: scrum-master
---

# Story 4.2 — Implement `submitLead` Server Action with validation + honeypot + rate limit

## Status
Approved

## Story
**As a** developer,
**I want** a Server Action `submitLead` that validates inputs, protects against spam, and returns a friendly result,
**so that** the form can be safely submitted without exposing secrets to the client.

## Acceptance Criteria
1. Server Action validates fields with Zod; soft-warns on free-mail but allows submit. [Source: architecture/03-backend-and-integrations.md#3.1]
2. Honeypot field and simple per-IP/session rate limit are enforced. [Source: architecture/03-backend-and-integrations.md#3.1, #3.3]
3. p50 < 800ms end-to-end measured in dev; failures return friendly error message. [Source: architecture/03-backend-and-integrations.md#3.9]
4. No secrets in client bundles; only server reads env vars. [Source: architecture/03-backend-and-integrations.md#3.4]

## Tasks / Subtasks
- [ ] Create `app/actions/submitLead.ts` with `'use server'`
- [ ] Define Zod schema: name, email, company, whatsapp, optional hidden `website` honeypot (max 0)
- [ ] Parse `FormData` → validation; return `{ ok: boolean, message?: string }`
- [ ] Add simple in-memory rate limit (stub for KV upgrade) and timing guard (>800ms bot timing)
- [ ] Add structured error handling; log error class + elapsed ms (server logs)
- [ ] Provide TODO for email send (wired in 4.3)

## Dev Notes

### Server Action Design
- Minimal server surface with Zod validation and spam controls. [Source: architecture/03-backend-and-integrations.md#3.1, #3.3]

### Secrets & Config
- Env variables are server-only; no leakage to client bundles. [Source: architecture/03-backend-and-integrations.md#3.4]

## Testing
- Unit: schema validates/invalidates inputs; honeypot rejected; free-mail soft-warn path allowed.
- Integration: simulate rapid repeats to verify rate limit path.

## Change Log
| Date       | Version | Description                                   | Author |
|------------|---------|-----------------------------------------------|--------|
| 2025-08-08 | 0.1     | Draft for `submitLead` Server Action created  | SM     |

## Dev Agent Record
To be filled by the development agent during implementation.


