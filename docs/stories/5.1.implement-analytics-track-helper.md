---
title: "Story 5.1: implement-analytics-track-helper"
status: Draft
owner: scrum-master
---

# Story 5.1 — Implement `lib/analytics/track.ts` per Architecture §2.9

## Status
In Review

## Story

**As a** developer,
**I want** a central `track(event, payload)` helper with deduping and common fields,
**so that** analytics events are consistent and reliable across the app.

## Acceptance Criteria

1. Helper attaches `{ path, ts, deviceType }` common fields. [Source: architecture/02-frontend-application-architecture.md#2.9]
2. Dedupe visibility events to avoid duplicates on remounts. [Source: architecture/02-frontend-application-architecture.md#2.9]
3. Emits to Vercel Web Analytics; no crash if analytics unavailable. [Source: architecture/02-frontend-application-architecture.md#2.9]
4. Event names match PRD taxonomy. [Source: prd/06-features.md#6.7]

## Tasks / Subtasks

- [x] Create `lib/analytics/track.ts` with `track(name: EventName, payload?: Record<string, unknown>)`
- [x] Export `EventName` union matching PRD §6.7
- [x] Implement dedupe mechanism (ref/WeakSet) for first-visibility events
- [x] Add no-op guard for SSR and missing analytics client

## Dev Notes

### Event Taxonomy & Payloads

- Event list and payload structure defined in Architecture §2.9 and PRD §6.7. [Source: architecture/02-frontend-application-architecture.md#2.9; prd/06-features.md#6.7]

### Robustness

- Guard for server-side; avoid throwing if `window.va` missing. [Source: architecture/02-frontend-application-architecture.md#2.9]

## Testing

- Unit: calling `track` on server-side does nothing; client adds common fields.
- Dedupe test: repeated visibility calls emit once.

## Dev Agent Record
- Implemented `EventName` union and `track(name, payload?)` with common fields `{ path, ts, deviceType }`.
- Added dedupe for first-visibility events with scoped key (`name|path|section|id`).
- Added safe shim for `window.va?.track` and SSR no-op guard.
- Updated `NavCtaBridge` and `SlideOverForm` to use new signature.
- Added `lib/analytics/track.test.ts` covering common fields and dedupe.

## Change Log

| Date       | Version | Description                              | Author |
| ---------- | ------- | ---------------------------------------- | ------ |
| 2025-08-08 | 0.1     | Draft for analytics track helper created | SM     |

## Dev Agent Record

To be filled by the development agent during implementation.
